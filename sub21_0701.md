2021年度 サブゼミ 第12回 データハンドリング3
================
Yoshinari Namba
2021/7/01

|                                   |
|-----------------------------------|
| データハンドリングの第3回目です． |

# 0. Setup & Agenda

## 準備1: Rプロジェクト

RStudioを開いて右上のタブの File -> New Project
から新規プロジェクトを作成しておいてください．

## 準備2: データ

今日使用するデータを作成します．Rプロジェクトが作成出来たら，下のコードをコピペして実行しておいてください．

``` r
# 今日使うデータの作成
## 教育年数と賃金
df_left1 <- data.frame(name = c('A', 'B', 'C', 'D'), 
                       education = c(12, 14, 14, 16),      # 教育年数
                       wage = c(2000, 3000, 3000, 3100))   # 賃金
df_left2 <- data.frame(name = c('D', 'E'), 
                       education = c(16, 14), 
                       wage = c(3100, 2700))
## 年齢と居住地
df_right <- data.frame(id = c('A', 'C', 'D', 'E'), 
                       age = c(19, 22, 23, 24),     # 年齢
                       area = c('kanto', 'kanto', 'kinki', 'shikoku')) # 居住地域
# 確認
df_left1
```

    ##   name education wage
    ## 1    A        12 2000
    ## 2    B        14 3000
    ## 3    C        14 3000
    ## 4    D        16 3100

``` r
df_left2
```

    ##   name education wage
    ## 1    D        16 3100
    ## 2    E        14 2700

``` r
df_right
```

    ##   id age    area
    ## 1  A  19   kanto
    ## 2  C  22   kanto
    ## 3  D  23   kinki
    ## 4  E  24 shikoku

## 準備3: パッケージ

今日も`tidyverse`を使用します．インストールが済んでいない人は先ず`install.packages('tidyverse')`を実行してくださいね．

``` r
# tidyverseの呼び出し
library(tidyverse)
```

    ## Warning: package 'tidyverse' was built under R version 4.0.3

    ## -- Attaching packages --------------------------------------- tidyverse 1.3.0 --

    ## v ggplot2 3.3.1     v purrr   0.3.4
    ## v tibble  3.0.1     v dplyr   1.0.2
    ## v tidyr   1.1.0     v stringr 1.4.0
    ## v readr   1.3.1     v forcats 0.5.0

    ## Warning: package 'tidyr' was built under R version 4.0.2

    ## Warning: package 'dplyr' was built under R version 4.0.3

    ## -- Conflicts ------------------------------------------ tidyverse_conflicts() --
    ## x dplyr::filter() masks stats::filter()
    ## x dplyr::lag()    masks stats::lag()

## Agenda

今日のAgendaは次の通りです．  
1. データ結合  
2. グループワーク

# 1. データ結合

## 1-1 {base}: rbind(), cbind(), merge()

今日は複数のデータを結合するコマンドを学びましょう．実は今までの講義で何度か触れています．まずはその確認です．

### 行で結合する: rbind()

データを行で結合したい場合は`rbind()`を使用します
(コードの意味は「row(行) +
bind(結合)」だと思われます)．まずは結合するデータ`df_left1`と`df_left2`をもう一度見てみましょう．

``` r
# 確認
df_left1
```

    ##   name education wage
    ## 1    A        12 2000
    ## 2    B        14 3000
    ## 3    C        14 3000
    ## 4    D        16 3100

``` r
df_left2
```

    ##   name education wage
    ## 1    D        16 3100
    ## 2    E        14 2700

次のようなコードを書きます．「行で結合する」という意味を確認してください．簡単に言うと縦に並べて結合するということです．

``` r
rbind(df_left1, df_left2)
```

    ##   name education wage
    ## 1    A        12 2000
    ## 2    B        14 3000
    ## 3    C        14 3000
    ## 4    D        16 3100
    ## 5    D        16 3100
    ## 6    E        14 2700

重複の観測がありますね．各自で重複行を削除してみてください．

### 列で結合する: cbind()

データを列で結合したい場合は`cbind()`を使用します
(コードの意味は「column(列) +
bind(結合)」だと思われます)．今度は`df_left1`と`df_right`を結合してみましょう．

``` r
# 確認
df_left1
```

    ##   name education wage
    ## 1    A        12 2000
    ## 2    B        14 3000
    ## 3    C        14 3000
    ## 4    D        16 3100

``` r
df_right
```

    ##   id age    area
    ## 1  A  19   kanto
    ## 2  C  22   kanto
    ## 3  D  23   kinki
    ## 4  E  24 shikoku

次のようなコードを書きます．「列で結合する」という意味を確認してください．

``` r
cbind(df_left1, df_right)
```

    ##   name education wage id age    area
    ## 1    A        12 2000  A  19   kanto
    ## 2    B        14 3000  C  22   kanto
    ## 3    C        14 3000  D  23   kinki
    ## 4    D        16 3100  E  24 shikoku

ただ，これでは`id`列前後で観測がずれてしまっています．`name`と`id`で紐づけて繋げたいですよね．

### 紐づけて結合する: merge()

`merge()`を使えば，特定の変数で紐づけて2つのデータフレームを結合できます．先ほどと同様に`df_left1`と`df_right`を結合してみましょう．前者の`name`と`id`を紐づけます．`by.x`で最初のデータフレームのキー変数，`by.y`で2番目のデータフレームのキー変数を指定します．

``` r
merge(df_left1, df_right, by.x = 'name', by.y = 'id')
```

    ##   name education wage age  area
    ## 1    A        12 2000  19 kanto
    ## 2    C        14 3000  22 kanto
    ## 3    D        16 3100  23 kinki

ちなみにキー変数の名前が同じ場合は by のみでOKです．

``` r
df_right_tmp <- df_right %>% 
  rename(name = id)

# キー変数の名前が同じ場合は by のみでOK
merge(df_left1, df_right_tmp, by = 'name')
```

    ##   name education wage age  area
    ## 1    A        12 2000  19 kanto
    ## 2    C        14 3000  22 kanto
    ## 3    D        16 3100  23 kinki

ここでもう一度結合前のデータを見てみてください．先ほどのマージの仕方だと片方のデータフレームのみで観測されているBさんやCさんが抜け落ちてしまっています．

``` r
df_left1 ; df_right
```

    ##   name education wage
    ## 1    A        12 2000
    ## 2    B        14 3000
    ## 3    C        14 3000
    ## 4    D        16 3100

    ##   id age    area
    ## 1  A  19   kanto
    ## 2  C  22   kanto
    ## 3  D  23   kinki
    ## 4  E  24 shikoku

## 1-2 {dplyr}: \*\_join()

# 2. グループワーク

グループワークです．

``` r
library(openxlsx)
```
