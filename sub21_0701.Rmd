---
title: "2021年度 サブゼミ 第12回 データハンドリング3"
author: "Yoshinari Namba"
date: "2021/7/01"
output: 
  github_document:
    pandoc_args: --webtex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---
データハンドリングの第3回目です．
---


# 0. Setup & Agenda

## 準備1: Rプロジェクト
RStudioを開いて右上のタブの File -> New Project から新規プロジェクトを作成しておいてください．

## 準備2: データ
今日使用するデータを作成します．Rプロジェクトが作成出来たら，下のコードをコピペして実行しておいてください．

```{r todays_data}
# 今日使うデータの作成
## 教育年数と賃金
df_left1 <- data.frame(name = c('A', 'B', 'C', 'D'), 
                       education = c(12, 14, 14, 16),      # 教育年数
                       wage = c(2000, 3000, 3000, 3100))   # 賃金
df_left2 <- data.frame(name = c('D', 'E'), 
                       education = c(16, 14), 
                       wage = c(3100, 2700))
## 年齢と居住地
df_right <- data.frame(id = c('A', 'C', 'D', 'E'), 
                       age = c(19, 22, 23, 24),     # 年齢
                       area = c('kanto', 'kanto', 'kinki', 'shikoku')) # 居住地域
# 確認
df_left1
df_left2
df_right
```

## 準備3: パッケージ
今日も`tidyverse`を使用します．インストールが済んでいない人は先ず`install.packages('tidyverse')`を実行してくださいね．

```{r library_tidyverse}
# tidyverseの呼び出し
library(tidyverse)
```

## Agenda
今日のAgendaは次の通りです．  
1. データ結合  
2. グループワーク  

# 1. データ結合
## 1-1 {base}: rbind(), cbind(), merge()
今日は複数のデータを結合するコマンドを学びましょう．実は今までの講義で何度か触れています．まずはその確認です．

### 行で結合する: rbind()
データを行で結合したい場合は`rbind()`を使用します (コードの意味は「row(行) + bind(結合)」だと思われます)．まずは結合するデータ`df_left1`と`df_left2`をもう一度見てみましょう．
```{r df_rbind_glimpse}
# 確認
df_left1
df_left2
```
次のようなコードを書きます．「行で結合する」という意味を確認してください．簡単に言うと縦に並べて結合するということです．
```{r}
rbind(df_left1, df_left2)
```
重複の観測がありますね．各自で重複行を削除してみてください．

### 列で結合する: cbind()
データを列で結合したい場合は`cbind()`を使用します (コードの意味は「column(列) + bind(結合)」だと思われます)．今度は`df_left1`と`df_right`を結合してみましょう．
```{r}
# 確認
df_left1
df_right
```
次のようなコードを書きます．「列で結合する」という意味を確認してください．
```{r}
cbind(df_left1, df_right)
```
ただ，これでは`id`列前後で観測がずれてしまっています．`name`と`id`で紐づけて繋げたいですよね．

### 紐づけて結合する: merge()
`merge()`を使えば，特定の変数で紐づけて2つのデータフレームを結合できます．先ほどと同様に`df_left1`と`df_right`を結合してみましょう．前者の`name`と`id`を紐づけます．`by.x`で最初のデータフレームのキー変数，`by.y`で2番目のデータフレームのキー変数を指定します．
```{r}
merge(df_left1, df_right, by.x = 'name', by.y = 'id')
```
ちなみにキー変数の名前が同じ場合は by のみでOKです．
```{r}
df_right_tmp <- df_right %>% 
  rename(name = id)

# キー変数の名前が同じ場合は by のみでOK
merge(df_left1, df_right_tmp, by = 'name')
```
ここでもう一度結合前のデータを見てみてください．先ほどのマージの仕方だと片方のデータフレームのみで観測されているBさんやCさんが抜け落ちてしまっています．
```{r}
df_left1 ; df_right
```




## 1-2 {dplyr}: *_join()



# 2. グループワーク

グループワークです．
```{r group_work, eval=FALSE}
library(openxlsx)
```
